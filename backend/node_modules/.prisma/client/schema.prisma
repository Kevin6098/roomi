// ROOMI Backend â€” Prisma schema (PostgreSQL)
// Spec: ROOMI_DEVELOPER_PRO.md

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "darwin-arm64"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  OWNER
  STAFF
}

enum PreferredLanguage {
  en
  jp
  cn
}

enum AcquisitionType {
  free
  cheap
  bought
}

enum ItemCondition {
  new
  good
  fair
  poor
}

enum ItemStatus {
  in_stock
  listed
  reserved
  rented
  sold
  disposed
}

enum RentalStatus {
  active
  ended
}

enum LocationVisibility {
  hidden
  shown
}

model User {
  id           String        @id @default(cuid())
  email        String        @unique
  passwordHash String
  role         UserRole      @default(STAFF)
  createdAt    DateTime      @default(now())
  activityLogs ActivityLog[]
}

model MainCategory {
  id            String        @id @default(cuid())
  name          String        @unique
  nameEn        String?
  nameJa        String?
  createdAt     DateTime      @default(now())
  subCategories SubCategory[]

  @@index([name])
}

model SubCategory {
  id             String       @id @default(cuid())
  mainCategoryId String
  name           String
  nameEn         String?
  nameJa         String?
  createdAt      DateTime     @default(now())
  mainCategory   MainCategory @relation(fields: [mainCategoryId], references: [id], onDelete: Restrict)
  items          Item[]

  @@unique([mainCategoryId, name])
  @@index([mainCategoryId])
}

model Contact {
  id               String     @id @default(cuid())
  sourcePlatform   String     @db.VarChar(50)
  platformUserId   String?    @db.VarChar(120)
  name             String     @db.VarChar(120)
  phone            String?    @db.VarChar(40)
  email            String?    @db.VarChar(120)
  notes            String?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  acquisitionItems Item[]
  customers        Customer[]

  @@index([name])
  @@index([sourcePlatform])
}

enum RentPeriod {
  monthly
  annually
}

model Item {
  id                   String             @id @default(cuid())
  title                String
  subCategoryId        String
  customSubCategory    String?            @db.VarChar(120)
  acquisitionContactId String?
  sourcePlatform       String? // deprecated; kept for migration
  acquisitionType      AcquisitionType
  acquisitionCost      Decimal            @default(0) @db.Decimal(12, 2)
  originalPrice        Decimal?           @db.Decimal(12, 2)
  condition            ItemCondition
  prefecture           String             @default("Undecided") @db.VarChar(50)
  city                 String             @default("Undecided") @db.VarChar(80)
  exactLocation        String?            @db.VarChar(255)
  locationVisibility   LocationVisibility @default(hidden)
  locationArea         String?
  status               ItemStatus         @default(in_stock)
  acquisitionDate      DateTime?
  notes                String?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  subCategory          SubCategory        @relation(fields: [subCategoryId], references: [id], onDelete: Restrict)
  acquisitionContact   Contact?           @relation(fields: [acquisitionContactId], references: [id], onDelete: SetNull)
  rentals              Rental[]
  sale                 Sale?

  @@index([status])
  @@index([subCategoryId])
  @@index([title])
  @@index([prefecture, city])
  @@index([acquisitionContactId])
}

model Customer {
  id                String            @id @default(cuid())
  contactId         String?           @unique
  name              String
  phone             String?
  email             String?
  preferredLanguage PreferredLanguage @default(en)
  sourcePlatform    String?
  appId             String?
  createdAt         DateTime          @default(now())
  contact           Contact?          @relation(fields: [contactId], references: [id], onDelete: SetNull)
  rentals           Rental[]
  sales             Sale[]

  @@index([name])
  @@index([phone])
  @@index([email])
}

model Rental {
  id                    String       @id @default(cuid())
  itemId                String
  customerId            String
  rentPeriod            RentPeriod   @default(monthly)
  rentPriceMonthly      Decimal?     @db.Decimal(12, 2)
  rentPriceAnnually     Decimal?     @db.Decimal(12, 2)
  deposit               Decimal?     @db.Decimal(12, 2)
  startDate             DateTime
  expectedEndDate       DateTime
  actualEndDate         DateTime?
  status                RentalStatus @default(active)
  damageFee             Decimal?     @db.Decimal(12, 2)
  notes                 String?
  handoverLocation      String?
  handoverPrefecture    String?      @db.VarChar(50)
  handoverCity          String?      @db.VarChar(80)
  handoverExactLocation String?      @db.VarChar(255)
  createdAt             DateTime     @default(now())
  item                  Item         @relation(fields: [itemId], references: [id], onDelete: Restrict)
  customer              Customer     @relation(fields: [customerId], references: [id], onDelete: Restrict)

  @@index([status])
  @@index([expectedEndDate])
  @@index([itemId])
  @@index([customerId])
}

model Sale {
  id                    String   @id @default(cuid())
  itemId                String   @unique
  customerId            String
  salePrice             Decimal? @db.Decimal(12, 2)
  saleDate              DateTime
  platformSold          String?
  notes                 String?
  handoverLocation      String?
  handoverPrefecture    String?  @db.VarChar(50)
  handoverCity          String?  @db.VarChar(80)
  handoverExactLocation String?  @db.VarChar(255)
  createdAt             DateTime @default(now())
  item                  Item     @relation(fields: [itemId], references: [id], onDelete: Restrict)
  customer              Customer @relation(fields: [customerId], references: [id], onDelete: Restrict)

  @@index([saleDate])
  @@index([customerId])
}

model ActivityLog {
  id         String   @id @default(cuid())
  userId     String?
  actionType String
  entityType String
  entityId   String?
  metadata   Json?
  createdAt  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([createdAt])
  @@index([actionType])
  @@index([entityType])
}
